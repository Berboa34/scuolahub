<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScuolaHub – Dashboard</title>
  <style>
    :root{
      --bg:#f7f7fb;--panel:#ffffff;--ink:#1b1f24;--muted:#6b7280;--primary:#2563eb;--primary-ink:#fff;--line:#e5e7eb;--chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:9;background:var(--panel);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#7c3aed);display:inline-grid;place-items:center;color:#fff;font-weight:700}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    nav a, nav button{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none;color:inherit}
    nav .active{background:var(--primary);color:var(--primary-ink);border-color:var(--primary)}
    main{padding:20px 0}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:1fr}.grid.cols-2{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .muted{color:var(--muted)}
    .kpi{display:flex;align-items:center;justify-content:space-between}
    .kpi b{font-size:1.4rem}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);color:#3730a3;font-size:.8rem}
    .status{font-size:.8rem;font-weight:600;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .status.active{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .status.draft{background:#f1f5f9;color:#334155}
    .status.closed{background:#fef2f2;color:#7f1d1d;border-color:#fecaca}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{font-size:.9rem;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:var(--primary-ink);border-color:var(--primary)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input{border:1px solid var(--line);padding:10px 12px;border-radius:10px;background:#fff}
    .hint{font-size:.9rem;color:var(--muted)}
    .flex{display:flex;gap:16px;align-items:center}
    .right{margin-left:auto}
    .progress{height:10px;background:#eef2ff;border-radius:8px;overflow:hidden}
    .progress>i{display:block;height:100%;background:var(--primary)}
    footer{padding:24px 0;color:var(--muted)}
    .view{display:block}
  </style>
</head>
<body>
{% load humanize %}

{% if user.is_authenticated %}
  <div style="background:#f1f1f1; padding:10px; border-bottom:1px solid #ccc; display:flex; gap:12px; align-items:center">
    <div><b>Benvenuto/a, {{ user.username }}</b>{% if school %} — <span class="muted">{{ school.name }}</span>{% endif %}</div>
    <div class="right">
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button class="btn" type="submit">Esci</button>
      </form>
    </div>
  </div>
{% endif %}

<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <strong>ScuolaHub</strong><br>
        <span class="muted">Dashboard collegata al database</span>
      </div>
    </div>
    <nav aria-label="Navigazione principale">
      <a href="#" class="active">Dashboard</a>
      <a href="#/projects">Progetti</a>
      <a href="#/calendar">Calendario</a>
      <a href="#/documents">Documenti</a>
      <a href="#/deleghe">Deleghe</a>
      <a href="#/settings">Impostazioni</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Badge di verifica DB -->
  <div class="card" style="margin-bottom:12px">
    <b>Dati reali dal database:</b>
    {% if projects and projects|length %} {{ projects|length }} progetti. Primo: <i>{{ projects.0.title }}</i>
    {% else %} nessun progetto trovato. {% endif %}
  </div>

  <!-- KPI -->
  <section class="view" aria-label="KPI">
    <div class="grid cols-3">
      <div class="card kpi">
        <div>
          <div class="muted">Budget allocato</div>
          <b>€ {{ totals.budget|floatformat:0|intcomma }}</b>
        </div>
        <span class="tag">{% if totals.budget %}+ aggiornato{% else %}—{% endif %}</span>
      </div>
      <div class="card kpi">
        <div>
          <div class="muted">Spesa effettuata</div>
          <b>€ {{ totals.spent|floatformat:0|intcomma }}</b>
        </div>
        <span class="tag">
          {% if totals.budget %}
            {% widthratio totals.spent totals.budget 100 %}% del totale
          {% else %}
            —
          {% endif %}
        </span>
      </div>
      <div class="card kpi">
        <div>
          <div class="muted">Scadenze entro 30 gg</div>
          <b>—</b>
        </div>
        <span class="status active">In corso</span>
      </div>
    </div>
  </section>

  <!-- Progetti in evidenza -->
  <section class="view" aria-label="Progetti in evidenza" style="margin-top:16px">
    <div class="card">
      <div class="flex">
        <h3>Progetti in evidenza</h3>
        <div class="right toolbar">
          <input id="search-featured" class="input" placeholder="Cerca progetto…" />
          <button class="btn">Filtri</button>
          <button class="btn primary" onclick="alert('Coming soon')">Nuovo progetto</button>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>Titolo</th><th>Programma</th><th>Periodo</th><th>Stato</th><th>Budget</th><th>Speso</th></tr>
        </thead>
        <tbody id="featured-tbody">
          {% for p in latest %}
            <tr data-project
                data-title="{{ p.title|lower }}"
                data-program="{{ p.get_program_display|default:p.program|lower }}"
                data-cup="{{ p.cup|default:''|lower }}"
                data-cig="{{ p.cig|default:''|lower }}"
                onclick="location.href='{% url 'project_detail' p.id %}'" style="cursor:pointer">
              <td>{{ p.title }}</td>
              <td>{{ p.get_program_display|default:p.program }}</td>
              <td>{{ p.start_date }} – {{ p.end_date }}</td>
              <td>
                <span class="status
                  {% if p.status == 'ACTIVE' %}active
                  {% elif p.status == 'DRAFT' %}draft
                  {% else %}closed{% endif %}">
                  {{ p.get_status_display|default:p.status }}
                </span>
              </td>
              <td>€ {{ p.budget|floatformat:0|intcomma }}</td>
              <td>€ {{ p.spent|floatformat:0|intcomma }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="6">Nessun progetto.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Tutti i progetti -->
  <section class="view" aria-label="Tutti i progetti" style="margin-top:16px">
    <div class="card">
      <div class="flex">
        <h3>Tutti i progetti</h3>
        <div class="right toolbar">
          <input id="search-projects" class="input" placeholder="Cerca per titolo, CUP, CIG, programma…" />
          <select id="filter-status" class="input" aria-label="Filtro stato">
            <option value="">Stato: tutti</option>
            <option value="draft">Bozza</option>
            <option value="active">In corso</option>
            <option value="closed">Chiuso</option>
          </select>
          <button class="btn" id="btn-export">Esporta</button>
          <button class="btn primary" onclick="alert('Coming soon')">Nuovo progetto</button>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>Titolo</th><th>Programma</th><th>CUP</th><th>Periodo</th><th>Stato</th><th class="right">% Spesa</th></tr>
        </thead>
        <tbody id="projects-tbody">
          {% for p in projects %}
            <tr data-project
                data-status="{{ p.status|lower }}"
                data-title="{{ p.title|lower }}"
                data-program="{{ p.get_program_display|default:p.program|lower }}"
                data-cup="{{ p.cup|default:''|lower }}"
                data-cig="{{ p.cig|default:''|lower }}"
                onclick="location.href='{% url 'project_detail' p.id %}'" style="cursor:pointer">
              <td>{{ p.title }}</td>
              <td>{{ p.get_program_display|default:p.program }}</td>
              <td>{{ p.cup|default:"—" }}</td>
              <td>{{ p.start_date }} – {{ p.end_date }}</td>
              <td>
                <span class="status
                  {% if p.status == 'ACTIVE' %}active
                  {% elif p.status == 'DRAFT' %}draft
                  {% else %}closed{% endif %}">
                  {{ p.get_status_display|default:p.status }}
                </span>
              </td>
              <td>
                <div class="progress">
                  <i style="width:
                    {% if p.budget and p.budget|floatformat != '0' %}
                      {% widthratio p.spent p.budget 100 %}
                    {% else %}0{% endif %}%"></i>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6">Nessun progetto trovato.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <p class="hint" style="margin-top:8px">Suggerimento: filtra per “pnrr”, “c12h”, “bozza”, ecc.</p>
    </div>
  </section>
</main>

<footer class="wrap">
  <span>© 2025 ScuolaHub – Dashboard collegata a database</span>
</footer>

<script>
  // === Ricerca live (dashboard: "Progetti in evidenza")
  const featuredSearch = document.getElementById('search-featured');
  const featuredBody = document.getElementById('featured-tbody');
  featuredSearch?.addEventListener('input', () => {
    const q = featuredSearch.value.toLowerCase().trim();
    [...featuredBody.querySelectorAll('tr[data-project]')].forEach(tr=>{
      const txt = [tr.dataset.title, tr.dataset.program, tr.dataset.cup, tr.dataset.cig].join(' ');
      tr.style.display = txt.includes(q) ? '' : 'none';
    });
  });

  // === Ricerca + filtro stato (lista Progetti)
  const projectsSearch = document.getElementById('search-projects');
  const statusFilter = document.getElementById('filter-status');
  const projectsBody = document.getElementById('projects-tbody');
  function applyProjectsFilters(){
    const q = (projectsSearch?.value || '').toLowerCase().trim();
    const st = (statusFilter?.value || '').toLowerCase().trim();
    [...projectsBody.querySelectorAll('tr[data-project]')].forEach(tr=>{
      const hay = [tr.dataset.title, tr.dataset.program, tr.dataset.cup, tr.dataset.cig].join(' ');
      const matchesText = !q || hay.includes(q);
      const matchesStatus = !st || (tr.dataset.status === st);
      tr.style.display = (matchesText && matchesStatus) ? '' : 'none';
    });
  }
  projectsSearch?.addEventListener('input', applyProjectsFilters);
  statusFilter?.addEventListener('change', applyProjectsFilters);

  // === Export CSV (demo)
  document.getElementById('btn-export')?.addEventListener('click', ()=>{
    const rows = [...document.querySelectorAll('#projects-tbody tr[data-project]')].filter(r=>r.style.display!=='none');
    const header = ['Titolo','Programma','CUP','Periodo','Stato','Percent'];
    const data = rows.map(r=>{
      const tds = r.querySelectorAll('td');
      const percent = (tds[5]?.querySelector('i')?.style.width || '').replace('%','');
      return [tds[0]?.innerText, tds[1]?.innerText, tds[2]?.innerText, tds[3]?.innerText, tds[4]?.innerText, percent];
    });
    const csv = [header, ...data].map(a=>a.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'progetti.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });
</script>
</body>
</html>
