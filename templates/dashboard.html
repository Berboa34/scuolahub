{% load humanize %}
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ScuolaHub ‚Äì Dashboard</title>
  <style>
    :root{
      --bg:#f7f7fb;--panel:#ffffff;--ink:#1b1f24;--muted:#6b7280;
      --primary:#2563eb;--primary-ink:#fff;--ok:#16a34a;--warn:#ca8a04;--bad:#dc2626;
      --line:#e5e7eb;--chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    .topbar{background:#f1f1f1;padding:10px;border-bottom:1px solid #ccc;display:flex;gap:12px;align-items:center}
    .topbar .right{margin-left:auto}
    .btn{
      padding:8px 12px;border:1px solid var(--primary);border-radius:4px;
      color:var(--primary);background:#fff;cursor:pointer;font-size:0.9rem;
      text-decoration:none;display:inline-block
    }
    .btn.primary{background:var(--primary);color:var(--primary-ink)}
    .btn:hover{opacity:0.9;text-decoration:none}

    .grid{display:grid;gap:20px}
    @media(min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--panel);padding:20px;border-radius:8px;border:1px solid var(--line);
      box-shadow:0 1px 3px rgba(0,0,0,0.05)
    }
    .progress-bar{
      background:var(--line);height:8px;border-radius:4px;overflow:hidden;
      margin-top:6px;position:relative
    }
    .progress-fill{
      height:100%;background:var(--primary);width:0;transition:width 0.5s ease
    }
    .progress-label{
      font-size:0.85rem;color:var(--muted);margin-top:4px
    }

    .project-list li{
      padding:10px 0;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center
    }
    .project-list li:last-child{border-bottom:none}
    .project-list .title{font-weight:bold}
    .project-list .spent{font-weight:bold;color:var(--ink)}

    .notification-list{list-style:none;padding:0;margin-top:10px}
    .notification-list li{
      padding:10px 0;border-bottom:1px solid var(--line);
      font-size:0.9rem
    }
    .notification-list li:last-child{border-bottom:none}

    .event-list{list-style:none;padding:0;margin-top:10px}
    .event-item{
      padding:10px 0;border-bottom:1px solid var(--line);
    }
    .event-item:last-child{border-bottom:none}
    .event-item-title{font-weight:bold;color:var(--primary)}
  </style>
</head>
<body>

  <div class="topbar">
    <div style="font-weight:bold;font-size:1.1rem;color:var(--primary)">ScuolaHub</div>
    <nav>
      <a href="{% url 'dashboard' %}" class="btn primary">Dashboard</a>
      <a href="{% url 'projects_list' %}" class="btn">Progetti</a>
      <a href="{% url 'deleghe_view' %}" class="btn">Deleghe</a>
      <a href="{% url 'calendar' %}" class="btn">Calendario</a>
      <a href="{% url 'calls_list' %}" class="btn">Bandi</a>
    </nav>
    <div class="right">
      <small>Benvenuto, {{ user.username }} | <a href="{% url 'logout' %}">Esci</a></small>
    </div>
  </div>

  <div class="wrap">
    <h1>Dashboard</h1>
    {% if school %}
      <p class="muted">Gestione per: <strong style="color:var(--ink)">{{ school.name }}</strong></p>
    {% elif is_superuser %}
      <p class="muted">Modalit√† Superuser.</p>
    {% else %}
      <p class="muted" style="color:var(--bad)">Nessuna scuola associata. Funzionalit√† limitate.</p>
    {% endif %}

    {% if messages %}
        {% for message in messages %}
            <div style="padding: 10px; border-radius: 4px; margin-bottom: 16px;
                        background: {% if message.tags == 'success' %}var(--ok){% elif message.tags == 'error' %}var(--bad){% else %}var(--warn){% endif %}1A;
                        color: {% if message.tags == 'success' %}var(--ok){% elif message.tags == 'error' %}var(--bad){% else %}var(--warn){% endif %};">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}


    <div class="grid cols-2">
      <div class="card">
        <h3>Riepilogo Finanziario (Aggregato)</h3>
        <p>Budget Totale: **‚Ç¨ {{ total_budget|intcomma }}**</p>
        <p>Speso Totale: **‚Ç¨ {{ total_spent|intcomma }}**</p>

        <div class="progress-label">Avanzamento Spesa (vs Budget)</div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:{{ progress_percent|floatformat:2 }}%;"></div>
        </div>
        <small style="color:var(--primary)">{{ progress_percent|floatformat:2 }}%</small>

        <h4 style="margin-top:30px">Progetti Recenti</h4>
        {% if projects %}
          <ul class="project-list">
            {% for project in projects %}
              <li>
                <div>
                  <a class="title" href="{% url 'project_detail' project.pk %}">{{ project.title }}</a>
                  <small class="muted" style="display:block">{{ project.program }} | Budget: ‚Ç¨ {{ project.budget|intcomma }}</small>
                </div>
                <span class="spent">Speso: ‚Ç¨ {{ project.calculated_spent|default:"0.00"|intcomma }}</span>
              </li>
            {% endfor %}
          </ul>
          <div style="margin-top:15px; text-align:right;">
             <a href="{% url 'projects_list' %}" class="btn">Vedi tutti ‚Üí</a>
          </div>
        {% else %}
          <p class="muted" style="margin-top:8px;font-size:0.9rem">
            Nessun progetto registrato.
          </p>
        {% endif %}
      </div>

      <div>
        <div class="card">
          <h3 style="margin:0">Notifiche ({{ notifications|length }})</h3>
          {% if notifications %}
            <ul class="notification-list">
              {% for n in notifications %}
                <li>
                  <a href="{% url 'notification_detail' n.pk %}">
                    {{ n.message|safe }}
                    <small style="color:var(--muted)">({{ n.created_at|date:"d M H:i" }})</small>
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted" style="margin-top:8px;font-size:0.9rem">
              Nessuna notifica presente.
            </p>
          {% endif %}
        </div>

        <div class="card" style="margin-top:24px">
          <div style="display:flex;align-items:center;gap:8px">
            <h3 style="margin:0">Prossimi eventi</h3>
            <div style="margin-left:auto">
              <a class="btn" href="{% url 'calendar' %}">Apri calendario ‚Üí</a>
            </div>
          </div>

          {% if upcoming_events %}
            <ul class="event-list">
              {% for ev in upcoming_events %}
                <li class="event-item">
                  <div class="event-item-title">{{ ev.title }}</div>
                  <small>
                    {{ ev.date|date:"d/m/Y" }}
                    {% if ev.project %}
                      ¬∑ Progetto: {{ ev.project.title }}
                    {% endif %}
                  </small>
                  {% if ev.description %}
                    <div style="margin-top:4px;font-size:0.85rem">{{ ev.description }}</div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted" style="margin-top:8px;font-size:0.9rem">
              Nessun evento futuro registrato. Vai al calendario per aggiungerne uno.
            </p>
          {% endif %}
        </div>

      </div>
    </div>

    <div class="card" style="margin-top: 24px;">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">Milestone Globali della Scuola (Attive)</h3>
        <div style="margin-left:auto">
          <small class="muted">{{ today|date:"d/m/Y" }} - Oggi</small>
        </div>
      </div>

      {% if total_milestones_count > 0 %}
      <p style="font-size: 0.9rem; margin-top: 12px; margin-bottom: 4px;">
          Progresso Generale: {{ completed_milestones_count }} di {{ total_milestones_count }} completate ({{ milestones_remaining }} rimaste).
      </p>
      {% endif %}

      {% if project_legend %}
          <p style="font-weight: bold; margin-top: 12px; margin-bottom: 4px; font-size: 0.9rem;">Legenda Progetti:</p>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
              {% for item in project_legend %}
                  <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; background: {{ item.color }}1A; color: {{ item.color }}; border: 1px solid {{ item.color }};">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: {{ item.color }};"></span>
                      {{ item.project_title }}
                  </span>
              {% endfor %}
          </div>
      {% endif %}

      {% if global_milestones %}
          <ul class="milestone-global-list" style="list-style: none; padding: 0;">
              {% for ms in global_milestones %}
                  {% if ms.status != 'COMPLETED' %}

                      {% comment %}
                      CORREZIONE CRITICA:
                      La logica if/elif/else contiene tutto il blocco WITH/ENDWITH e il codice di output,
                      evitando TemplateSyntaxError: expected 'endwith'.
                      {% endcomment %}

                      {% if ms.is_delayed %}
                          {% with status_color='var(--bad)' status_icon='‚ùå' status_label='SCADUTA!' %}
                              <li style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid var(--line);">
                                  <div style="flex-grow: 1;">
                                      <span style="font-weight: bold; color: {{ ms.color }};">{{ status_icon }} {{ ms.title }}</span>
                                      <small style="margin-left: 8px; color: {{ status_color }};">
                                          ({{ status_label }})
                                      </small>
                                      <div style="font-size: 0.85rem; margin-top: 2px;">
                                          Progetto: <a href="{% url 'project_detail' ms.project_id %}" style="color:{{ ms.color}}">{{ ms.project_title }}</a>
                                      </div>
                                  </div>
                                  <div style="font-weight: bold; font-size: 1rem; color: {{ status_color }}; white-space: nowrap;">
                                      {{ ms.due_date|date:"d/m/Y" }}
                                  </div>
                              </li>
                          {% endwith %}

                      {% elif ms.status == 'PENDING' %}
                          {% with status_color='var(--warn)' status_icon='‚è≥' status_label='In attesa' %}
                              <li style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid var(--line);">
                                  <div style="flex-grow: 1;">
                                      <span style="font-weight: bold; color: {{ ms.color }};">{{ status_icon }} {{ ms.title }}</span>
                                      <small style="margin-left: 8px; color: {{ status_color }};">
                                          ({{ status_label }})
                                      </small>
                                      <div style="font-size: 0.85rem; margin-top: 2px;">
                                          Progetto: <a href="{% url 'project_detail' ms.project_id %}" style="color:{{ ms.color}}">{{ ms.project_title }}</a>
                                      </div>
                                  </div>
                                  <div style="font-weight: bold; font-size: 1rem; color: {{ status_color }}; white-space: nowrap;">
                                      {{ ms.due_date|date:"d/m/Y" }}
                                  </div>
                              </li>
                          {% endwith %}

                      {% else %}
                          {% with status_color='var(--primary)' status_icon='‚è≥' status_label='In corso' %}
                              <li style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid var(--line);">
                                  <div style="flex-grow: 1;">
                                      <span style="font-weight: bold; color: {{ ms.color }};">{{ status_icon }} {{ ms.title }}</span>
                                      <small style="margin-left: 8px; color: {{ status_color }};">
                                          ({{ status_label }})
                                      </small>
                                      <div style="font-size: 0.85rem; margin-top: 2px;">
                                          Progetto: <a href="{% url 'project_detail' ms.project_id %}" style="color:{{ ms.color}}">{{ ms.project_title }}</a>
                                      </div>
                                  </div>
                                  <div style="font-weight: bold; font-size: 1rem; color: {{ status_color }}; white-space: nowrap;">
                                      {{ ms.due_date|date:"d/m/Y" }}
                                  </div>
                              </li>
                          {% endwith %}
                      {% endif %}


                  {% endif %}
              {% endfor %}
          </ul>

          {% if milestones_remaining == 0 %}
               <p class="muted" style="margin-top:8px;font-size:0.9rem;">Tutte le milestone attive sono state completate. üéâ</p>
          {% endif %}

      {% else %}
          <p class="muted" style="margin-top:8px;font-size:0.9rem;">
              Nessuna milestone attiva registrata per i progetti della tua scuola.
          </p>
      {% endif %}
    </div>
    </div>
</body>
</html>