{% load humanize %}
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Bandi – ScuolaHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      margin:0;
      background:#f3f4f6;
      color:#111827;
    }
    a{color:#0b5cab;text-decoration:none}
    a:hover{text-decoration:underline}
    header{background:#0b2a42;color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topnav{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:#6b7280}
    .card{
      background:#fff;
      border-radius:10px;
      border:1px solid #e5e7eb;
      padding:16px;
      margin-top:16px;
    }
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    input[type="text"], select{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      font-size:14px;
    }
    .btn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-size:14px;
    }
    .btn.primary{background:#0b5cab;border-color:#0b5cab;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 10px;border-bottom:1px solid #e5e7eb;vertical-align:top}
    th{text-align:left;background:#f9fafb;font-weight:600}
    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#374151;
    }
    .status-OPEN{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .status-CLOSED{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
    .status-IN_PREP{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}
    .status-FUNDED{background:#ecfdf5;border-color:#6ee7b7;color:#047857}
    .status-NOT_FUNDED{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="topnav">
      <div class="muted" style="font-size:13px">
        <a href="{% url 'dashboard' %}" style="color:#cfe3ff;">← Torna alla Dashboard</a>
      </div>
      <div class="muted" style="font-size:13px">
        Utente: <b>{{ request.user.username }}</b>
        {% if school %} · Scuola: <b>{{ school.name }}</b>{% endif %}
      </div>
    </div>
    <h1 style="margin:8px 0 0;">Bandi</h1>
    <p class="muted" style="margin:4px 0 0;font-size:14px">
      Elenco unificato di bandi (PNRR, FSE, FESR, Erasmus+, ecc.), filtrabili per programma, stato e testo libero.
    </p>
  </div>
</header>

<main class="wrap">

  <div class="card">
    <form method="get" class="filters">
      <input type="text" name="q" placeholder="Cerca per titolo, fonte, codice..."
             value="{{ search|default:'' }}">

      <select name="program">
        <option value="">Tutti i programmi</option>
        {% for val,label in PROGRAM_CHOICES %}
          <option value="{{ val }}" {% if program == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <select name="status">
        <option value="">Tutti gli stati</option>
        {% for val,label in STATUS_CHOICES %}
          <option value="{{ val }}" {% if status == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      <button class="btn primary" type="submit">Filtra</button>
      <a href="{% url 'bandi_list' %}" class="btn">Azzera</a>
    </form>

    <div style="font-size:13px;margin-bottom:8px" class="muted">
      Trovati <b>{{ bandi|length }}</b> bandi.
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="width:32%">Titolo</th>
            <th style="width:12%">Programma</th>
            <th style="width:14%">Fonte</th>
            <th style="width:14%">Scadenza</th>
            <th style="width:14%">Stato</th>
            <th style="width:14%">Importo</th>
          </tr>
        </thead>
        <tbody>
          {% for b in bandi %}
            <tr>
              <td>
                <a href="{% url 'bando_detail' b.id %}"><b>{{ b.title }}</b></a><br>
                <span class="muted" style="font-size:12px">
                  {% if b.internal_code %}Cod. interno: {{ b.internal_code }} · {% endif %}
                  Inserito: {{ b.imported_at|date:"d/m/Y" }}
                </span>
              </td>
              <td class="small">{{ b.get_program_display }}</td>
              <td class="small">
                {{ b.source_name }}<br>
                {% if b.source_url %}
                  <a href="{{ b.source_url }}" target="_blank" class="muted" style="font-size:12px">
                    Apri fonte esterna ↗
                  </a>
                {% endif %}
              </td>
              <td class="small">
                {% if b.deadline_date %}
                  {{ b.deadline_date|date:"d/m/Y" }}
                {% else %}
                  <span class="muted">n.d.</span>
                {% endif %}
              </td>
              <td>
                <span class="badge status-{{ b.status }}">
                  {{ b.get_status_display }}
                </span>
              </td>
              <td class="small">
                {% if b.amount_available %}
                  € {{ b.amount_available|floatformat:0|intcomma }}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="muted" style="font-size:13px">
                Nessun bando trovato con i filtri attuali.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:12px;font-size:13px">
      Nota: in questa fase i bandi vengono inseriti manualmente o tramite importazione
      da fonti esterne (file, newsletter, portali). In prospettiva, la stessa struttura
      potrà essere alimentata automaticamente tramite API dedicate.
    </p>
  </div>

</main>

</body>
</html>
