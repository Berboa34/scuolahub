<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ScuolaHub – Dettaglio progetto</title>
  <style>
    :root{--bg:#f7f7fb;--panel:#fff;--ink:#1b1f24;--muted:#6b7280;--primary:#2563eb;--line:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:9;background:var(--panel);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#7c3aed);display:inline-grid;place-items:center;color:#fff;font-weight:700}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    nav a{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;color:inherit}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1.2fr .8fr}
    @media (max-width:1000px){.grid.cols-2{grid-template-columns:1fr}}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .input,select{border:1px solid var(--line);padding:10px 12px;border-radius:10px;background:#fff}
    table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi .box{border:1px solid var(--line);border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">S</div>
        <div>
          <strong>ScuolaHub</strong><br>
          <span class="muted">Dettaglio progetto</span>
        </div>
        <a class="btn" href="/">← Dashboard</a>
        <a class="btn" href="/progetti/">← Torna ai Progetti</a>
      </div>
      <nav aria-label="Navigazione">
        <a href="/">Dashboard</a>
        <a href="/progetti/">Progetti</a>
        <a href="/calendario/">Calendario</a>
        <a href="/documenti/">Documenti</a>
        <a href="/deleghe/">Deleghe</a>
        <a href="/impostazioni/">Impostazioni</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="toolbar">
        <div>
          <h2 style="margin:0">{{ project.title }}</h2>
          <div class="muted">{{ project.get_program_display }} · CUP {{ project.cup|default:"—" }} · {{ project.start_date }} – {{ project.end_date }}</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:12px">
        <div class="box"><div class="muted">Budget</div><div><b>€ {{ project.budget|floatformat:0 }}</b></div></div>
        <div class="box"><div class="muted">Speso</div><div><b>€ {{ project.spent|floatformat:0 }}</b></div></div>
        <div class="box"><div class="muted">% Spesa</div><div><b>
          {% if project.budget %}{{ project.spent|divisibleby:0 }}{% endif %}
          {{ project.spent|floatformat:0 }} / {{ project.budget|floatformat:0 }}
        </b></div></div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">Spese</h3>
          <form method="get" class="toolbar" style="margin-left:auto">
            <select name="cat" class="input">
              <option value="">Categoria: tutte</option>
              {% for key,label in categories %}
                <option value="{{ key }}" {% if request.GET.cat == key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <input class="input" type="search" name="vendor" value="{{ request.GET.vendor|default:'' }}" placeholder="Fornitore…">
            <button class="btn" type="submit">Filtra</button>
            <a class="btn" href="?">Pulisci</a>
          </form>
        </div>

        <table style="margin-top:8px">
          <thead><tr><th>Data</th><th>Categoria</th><th>Fornitore</th><th>Importo</th><th>Nota</th></tr></thead>
          <tbody>
            {% for e in expenses %}
            <tr>
              <td>{{ e.date }}</td>
              <td>{{ e.get_category_display }}</td>
              <td>{{ e.vendor|default:"—" }}</td>
              <td>€ {{ e.amount|floatformat:0 }}</td>
              <td>{{ e.note|default:"" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5">Nessuna spesa.</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <form method="post" class="toolbar" style="margin-top:12px">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_expense">
          <input class="input" type="date" name="date" required>
          <select name="category" class="input" required>
            {% for key,label in categories %}
              <option value="{{ key }}">{{ label }}</option>
            {% endfor %}
          </select>
          <input class="input" type="text" name="vendor" placeholder="Fornitore">
          <input class="input" type="number" step="0.01" name="amount" placeholder="Importo" required>
          <input class="input" type="text" name="note" placeholder="Nota">
          <button class="btn primary" type="submit">Aggiungi spesa</button>
        </form>
      </div>

      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">Limiti di spesa (per categoria)</h3>
        </div>

        <table style="margin-top:8px">
          <thead><tr><th>Categoria</th><th>Base calcolo</th><th>Percentuale</th><th>Consentito</th><th>Usato</th><th>Residuo</th></tr></thead>
          <tbody>
            {% for row in limits_table %}
            <tr>
              <td>{{ row.limit.get_category_display }}</td>
              <td>{{ row.base_label }}</td>
              <td>{{ row.limit.percentage }}%</td>
              <td>€ {{ row.allowed|floatformat:0 }}</td>
              <td>€ {{ row.used|floatformat:0 }}</td>
              <td>€ {{ row.remaining|floatformat:0 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="6">Nessun limite configurato.</td></tr>
            {% endfor %}
          </tbody>
        </table>

        <form method="post" class="toolbar" style="margin-top:12px">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_limit">
          <select name="limit_category" class="input" required>
            {% for key,label in categories %}
              <option value="{{ key }}">{{ label }}</option>
            {% endfor %}
          </select>
          <select name="base" class="input" required>
            <option value="BUDGET">Base: Budget</option>
            <option value="SPENT">Base: Speso attuale</option>
            <option value="REMAINING">Base: Residuo</option>
          </select>
          <input class="input" type="number" step="0.01" name="percentage" placeholder="% (es. 20)" required>
          <button class="btn primary" type="submit">Aggiungi limite</button>
        </form>
      </div>
    </div>
  </main>
</body>
</html>
