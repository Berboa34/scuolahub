{% load humanize %}
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>{{ project.title }} — Dettaglio progetto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b2a42; --light:#f5f7fb; --muted:#6b7280; --br:#e5e7eb; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:#0b5cab;text-decoration:none} a:hover{text-decoration:underline}
    header{background:var(--bg);color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topnav{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .crumbs a{color:#cde1ff}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
    .card{background:#fff;border:1px solid var(--br);border-radius:10px;padding:16px}
    .muted{color:var(--muted)}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
    .kpi{padding:12px;border:1px dashed var(--br);border-radius:8px;background:var(--light)}
    .progress{height:10px;background:#e6edf6;border-radius:999px;overflow:hidden}
    .bar{height:100%}
    .bar.ok{background:var(--ok)} .bar.warn{background:var(--warn)} .bar.bad{background:var(--bad)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--br);vertical-align:top}
    th{text-align:left;background:#f8fafc;font-weight:600}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid var(--br);background:#fff;cursor:pointer}
    .btn.primary{background:#0b5cab;color:#fff;border-color:#0b5cab}
    .btn.danger{background:#dc2626;color:#fff;border-color:#dc2626}
    form.inline{display:inline}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input[type="text"], select, input[type="date"], input[type="number"]{padding:8px;border-radius:8px;border:1px solid var(--br)}
    .section-title{margin:0 0 10px 0;font-size:18px}
    .small{font-size:13px}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eef2ff;color:#334155;font-size:12px;border:1px solid #c7d2fe}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="topnav">
      <div class="crumbs small">
        <a href="{% url 'dashboard' %}">← Torna alla Dashboard</a> ·
        <a href="{% url 'projects_list' %}">Torna a Progetti</a>
      </div>
      <div class="small">
        Utente: <b>{{ request.user.username }}</b>
        {% if request.user.is_staff %}<span class="badge">staff</span>{% endif %}
      </div>
    </div>
    <h1 style="margin:8px 0 2px">{{ project.title }}</h1>
    <div class="muted">
      {% if project.school %}Scuola: <b>{{ project.school.name }}</b> · {% endif %}
      Programma: <b>{{ project.program }}</b> ·
      Stato: <b>{{ project.get_status_display }}</b>
      {% if project.cup %} · CUP: {{ project.cup }}{% endif %}
      {% if project.cig %} · CIG: {{ project.cig }}{% endif %}
    </div>
  </div>
</header>

<main class="wrap" style="padding:16px 16px 40px">
  <!-- KPIs di progetto -->
  <div class="card">
    <div class="kpis">
      <div class="kpi">
        <div class="muted small">Budget totale</div>
        <div><b>€ {{ project.budget|floatformat:0|intcomma }}</b></div>
      </div>
      <div class="kpi">
        <div class="muted small">Speso totale</div>
        <div><b>€ {{ total_spent|floatformat:0|intcomma }}</b></div>
      </div>
      <div class="kpi">
        <div class="muted small">Avanzamento</div>
        <div class="progress" aria-hidden="true">
          {% with p=progress_percent %}
            {% if p >= 90 %}
              <div class="bar bad" style="width: {{ p }}%"></div>
            {% elif p >= 70 %}
              <div class="bar warn" style="width: {{ p }}%"></div>
            {% else %}
              <div class="bar ok" style="width: {{ p }}%"></div>
            {% endif %}
          {% endwith %}
        </div>
        <div class="small muted">{{ progress_percent|floatformat:0 }}% del budget</div>
      </div>
    </div>
  </div>

  <div class="grid cols-2" style="margin-top:16px">
    <!-- COLONNA SINISTRA: SPESE -->
    <section class="card">
      <h2 class="section-title">Spese</h2>

      <!-- Filtri -->
      <form method="get" class="filters" action="">
        <select name="category">
          <option value="">Tutte le categorie</option>
          {% for val,label in category_choices %}
            <option value="{{ val }}" {% if request.GET.category == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>

        <input type="text" name="vendor" placeholder="Fornitore contiene…" value="{{ request.GET.vendor|default:'' }}" />

        <button class="btn" type="submit">Filtra</button>
        <a class="btn" href="?">Azzera</a>
        <span class="muted small">Totale filtrato: <b>€ {{ filtered_total|floatformat:0|intcomma }}</b></span>
      </form>

      <!-- Tabella spese -->
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:110px">Data</th>
              <th>Fornitore</th>
              <th style="width:150px">Categoria</th>
              <th style="width:130px">Importo</th>
              <th style="width:120px">Documento</th>
              <th>Note</th>
              <th style="width:110px">Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for e in expenses %}
              <tr>
                <td class="small">{{ e.date|date:"d/m/Y" }}</td>
                <td>{{ e.vendor|default:"—" }}</td>
                <td class="small">{{ e.get_category_display }}</td>
                <td><b>€ {{ e.amount|floatformat:2|intcomma }}</b></td>
                <td class="small">{{ e.document|default:"—" }}</td>
                <td class="small">{{ e.note|default:"" }}</td>
                <td>
                  <form class="inline" method="post" action="{% url 'expense_delete' e.id %}" onsubmit="return confirm('Eliminare questa spesa?');">
                    {% csrf_token %}
                    <button type="submit" class="btn danger">Elimina</button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="muted small">Nessuna spesa trovata.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Aggiungi spesa -->
      <details style="margin-top:16px" {% if add_expense %}open{% endif %}>
        <summary class="btn">+ Aggiungi spesa</summary>
        <form method="post" action="" style="margin-top:12px" class="grid">
          {% csrf_token %}
          <input type="hidden" name="op" value="add_expense" />
          <div>
            <label class="small muted">Data</label><br>
            <input type="date" name="date" value="{{ today }}">
          </div>
          <div>
            <label class="small muted">Fornitore</label><br>
            <input type="text" name="vendor" placeholder="Es. Fornitore Srl">
          </div>
          <div>
            <label class="small muted">Categoria</label><br>
            <select name="category">
              {% for val,label in category_choices %}
                <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="small muted">Importo</label><br>
            <input type="number" name="amount" step="0.01" min="0" placeholder="0.00">
          </div>
          <div>
            <label class="small muted">Documento</label><br>
            <input type="text" name="document" placeholder="Es. Fattura 15/2025">
          </div>
          <div style="grid-column:1/-1">
            <label class="small muted">Note</label><br>
            <input type="text" name="note" placeholder="Annotazioni (facoltative)">
          </div>
          <div>
            <button class="btn primary" type="submit">Salva spesa</button>
          </div>
        </form>
      </details>
    </section>

    <!-- COLONNA DESTRA: LIMITI -->
    <section class="card">
      <h2 class="section-title">Limiti di spesa per categoria</h2>

      <div class="small muted" style="margin-bottom:8px">
        Base calcolo: “Percentuale sul totale speso” oppure “Percentuale sul budget totale”.
      </div>

      <div style="display:grid;gap:12px">
        {% for L in limits_ctx %}
          <div style="border:1px solid var(--br); border-radius:8px; padding:12px">
            <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
              <div>
                <b>{{ L.category_label }}</b>
                <div class="small muted">{{ L.base_label }} — Limite: {{ L.percentage|floatformat:2 }}%</div>
                {% if L.note %}<div class="small muted">Nota: {{ L.note }}</div>{% endif %}
              </div>
              <div class="small muted">
                Consentito: <b>€ {{ L.allowed_total|floatformat:0|intcomma }}</b> ·
                Speso: <b>€ {{ L.spent_in_category|floatformat:0|intcomma }}</b> ·
                Residuo: <b>€ {{ L.remaining|floatformat:0|intcomma }}</b>
              </div>
            </div>

            <div class="progress" style="margin-top:8px">
              {% with p=L.pct_used %}
                {% if p >= 100 %}
                  <div class="bar bad" style="width:100%"></div>
                {% elif p >= 80 %}
                  <div class="bar warn" style="width: {{ p }}%"></div>
                {% else %}
                  <div class="bar ok" style="width: {{ p }}%"></div>
                {% endif %}
              {% endwith %}
            </div>
            <div class="small muted" style="margin-top:4px">
              Utilizzo: <b>{{ L.pct_used|floatformat:0 }}%</b>
            </div>

            <!-- Modifica limite -->
            <form method="post" action="{% url 'limit_update' L.limit_id %}" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px;">
              {% csrf_token %}
              <select name="category" required>
                {% for val,label in category_choices %}
                  <option value="{{ val }}" {% if val == L.category %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>

              <select name="base" required>
                {% for val,label in base_choices %}
                  <option value="{{ val }}" {% if val == L.base %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>

              <input type="number" name="percentage" step="0.01" min="0" max="100" value="{{ L.percentage }}">
              <input type="text" name="note" placeholder="Nota (opz.)" value="{{ L.note|default:'' }}">
              <button class="btn" type="submit">Modifica</button>
            </form>

            <!-- Elimina limite -->
            <form method="post" action="{% url 'limit_delete' L.limit_id %}" onsubmit="return confirm('Eliminare questo limite?');" style="margin-top:6px;">
              {% csrf_token %}
              <button class="btn danger" type="submit">Elimina limite</button>
            </form>
          </div>
        {% empty %}
          <div class="muted small">Nessun limite impostato.</div>
        {% endfor %}
      </div>

      <!-- Aggiungi limite -->
      <details style="margin-top:16px" {% if add_limit %}open{% endif %}>
        <summary class="btn">+ Aggiungi limite</summary>
        <form method="post" action="" style="margin-top:12px" class="grid">
          {% csrf_token %}
          <input type="hidden" name="op" value="add_limit" />
          <div>
            <label class="small muted">Categoria</label><br>
            <select name="category">
              {% for val,label in category_choices %}
                <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="small muted">Base</label><br>
            <select name="base">
              {% for val,label in base_choices %}
                <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="small muted">% Limite</label><br>
            <input type="number" name="percentage" step="0.01" min="0" placeholder="Es. 20.00">
          </div>
          <div style="grid-column:1/-1">
            <label class="small muted">Nota</label><br>
            <input type="text" name="note" placeholder="Facoltativa">
          </div>
          <div>
            <button class="btn primary" type="submit">Salva limite</button>
          </div>
        </form>
      </details>
    </section>
  </div>


  <section id="milestones" style="margin-top:30px">
  <h2>Tappe Fondamentali (Milestone)</h2>

  {% if milestones %}
    <style>
      /* Stili CSS per la Timeline */
      .timeline {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-top: 20px;
        position: relative;
        overflow-x: auto; /* Permette lo scroll se ci sono molte milestone */
        padding-bottom: 20px;
        min-height: 100px; /* Assicura spazio anche con poche milestone */
      }
      .timeline-bar {
        position: absolute;
        top: 30px;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--br); /* Colore grigio chiaro per la linea di base */
      }
      .milestone-point {
        flex: 1;
        min-width: 150px; /* Larghezza minima per ogni tappa */
        text-align: center;
        position: relative;
        z-index: 10;
      }
      .milestone-circle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin: 0 auto 10px;
        position: relative;
        top: 25px; /* Posiziona sul centro della linea */
        border: 3px solid #fff; /* Bordo bianco per farla risaltare sulla linea */
        transition: background-color 0.3s;
      }
      /* I colori qui usano le variabili CSS già definite nel tuo file detail.html */
      .milestone-point.completed .milestone-circle { background-color: var(--ok); }
      .milestone-point.delayed .milestone-circle { background-color: var(--bad); }
      .milestone-point.pending .milestone-circle { background-color: var(--warn); }

      .milestone-date { font-size: 0.8em; color: var(--muted); margin-top: 35px; }
      .milestone-title { font-weight: 600; margin-top: 5px; }

      /* Linea di avanzamento (opzionale: richiede logica in JS o view) */
      .progress-line {
        position: absolute;
        top: 30px;
        left: 0;
        height: 4px;
        background: var(--ok);
        width: 0%;
        transition: width 0.5s;
      }
    </style>

    <div class="card" style="overflow:visible; padding-bottom: 30px;">
      <div class="timeline">
        <div class="timeline-bar"></div>

        {% comment %} Il calcolo della percentuale di progresso (% di milestone completate) andrebbe fatto qui, ma per ora usiamo 0% {% endcomment %}
        <div class="progress-line" style="width: 0%;"></div>

        {% for m in milestones %}
          {% comment %} Imposta la classe in base allo stato (per i colori) {% endcomment %}
          {% with status_class=m.status|lower %}

          <div class="milestone-point {{ status_class }} {% if m.due_date < today and m.status == 'PENDING' %}delayed{% endif %}">
            <div class="milestone-circle"></div>
            <div class="milestone-date">{{ m.due_date|date:"d M Y" }}</div>
            <div class="milestone-title">{{ m.title }}</div>
          </div>

          {% endwith %}
        {% endfor %}
      </div>
    </div>
  {% else %}
    <p class="muted card">Nessuna tappa fondamentale (milestone) definita per questo progetto.</p>
  {% endif %}
</section>


</main>

</body>
</html>
