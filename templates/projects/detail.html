{% load humanize %}
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>{{ project.title }} — Dettaglio progetto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b2a42; --light:#f5f7fb; --muted:#6b7280; --br:#e5e7eb; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:#0b5cab;text-decoration:none} a:hover{text-decoration:underline}\
    header{background:var(--bg);color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topnav{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .crumbs a{color:#cde1ff}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
    .card{background:#fff;border:1px solid var(--br);border-radius:4px;padding:16px}
    .small{font-size:0.85rem} .muted{color:var(--muted)}
    .text-center{text-align:center} .text-right{text-align:right}

    /* KPI */
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
    .kpi-card{padding:12px 16px;background:#fff;border:1px solid var(--br);border-radius:4px}
    .kpi-card h4{margin:0;font-size:1.1rem}
    .kpi-card strong{font-size:1.75rem;display:block;margin-top:4px}

    /* BARRE DI PROGRESSO */
    .progress-bar-container{width:100%;height:10px;background:#f0f0f0;border-radius:5px;margin-top:8px;overflow:hidden}
    .progress-bar{height:100%;background:var(--primary);transition:width 0.3s}
    .progress-bar.ok{background:var(--ok)} .progress-bar.warn{background:var(--warn)} .progress-bar.bad{background:var(--bad)}

    /* TIMELINE */
    .timeline-container{position:relative;height:50px;margin:24px 0}
    .timeline-bar{height:4px;background:#ddd;position:absolute;top:50%;width:100%;transform:translateY(-50%)}
    .today-marker{position:absolute;top:50%;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:8px solid var(--bg);transform:translate(-50%,-50%);z-index:2;cursor:help;transition:left 0.5s ease-out}
    .today-label{position:absolute;top:-25px;left:50%;transform:translateX(-50%);font-size:0.75rem;white-space:nowrap;color:var(--bg)}
    .ms-marker{position:absolute;top:50%;width:12px;height:12px;border-radius:50%;background:#aaa;transform:translate(-50%,-50%);z-index:1;border:2px solid #fff;transition:left 0.5s ease-out}
    .ms-marker.completed{background:var(--ok)}
    .ms-marker.delayed{background:var(--warn)}
    .ms-marker-label{position:absolute;top:20px;left:50%;transform:translateX(-50%);font-size:0.75rem;white-space:nowrap;cursor:default}
    .timeline-details{display:flex;justify-content:space-between;font-size:0.75rem;margin-top:8px}

    /* TABELLE */
    .simple-table{width:100%;border-collapse:collapse;font-size:0.9rem;margin-top:12px}
    .simple-table th,.simple-table td{padding:8px;border-bottom:1px solid var(--br)}
    .simple-table th{text-align:left;background:#f9f9f9;font-weight:600}
    .simple-table tbody tr:hover{background:#fafafa}
    .chip{display:inline-block;padding:2px 8px;border-radius:12px;background:#eee;font-size:0.75rem;color:var(--ink)}

    /* FORM */
    .grid input[type="text"],.grid input[type="number"],.grid input[type="date"],.grid select{width:100%;padding:8px;border:1px solid var(--br);border-radius:4px}
    .btn{padding:8px 16px;border:1px solid var(--br);border-radius:4px;cursor:pointer;background:#fff;text-align:center;display:inline-block;font-size:0.9rem}
    .btn.primary{background:var(--bg);color:#fff;border-color:var(--bg)}
    .btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
    .btn:hover{text-decoration:none;opacity:0.9}
    .messages{padding:12px;margin-bottom:16px;border-radius:4px;font-size:0.9rem}
    .messages.success{background:#dcfce7;border:1px solid var(--ok);color:var(--ok)}
    .messages.error{background:#fee2e2;border:1px solid var(--bad);color:var(--bad)}
    .messages.warning{background:#fef3c7;border:1px solid var(--warn);color:var(--warn)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topnav">
        <div>
          <div class="crumbs small"><a href="{% url 'dashboard' %}">Dashboard</a> / {{ project.title }}</div>
          <h1 style="margin:4px 0 0">{{ project.title }}</h1>
        </div>
        <div class="small">
          <a href="{% url 'project_list' %}" class="btn">← Tutti i progetti</a>
        </div>
      </div>
    </div>
  </header>

  <main style="padding:16px 0">
    <div class="wrap">
      {% if messages %}
        {% for message in messages %}
          <div class="messages {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <div class="card" style="margin-bottom:16px">
        <h3 style="margin-top:0">Riepilogo e KPI</h3>
        <div class="kpi-grid">
          <div class="kpi-card">
            <h4 class="small muted">Budget Totale</h4>
            <strong>{{ project.budget|floatformat:2|intcomma }}€</strong>
          </div>
          <div class="kpi-card">
            <h4 class="small muted">Totale Speso</h4>
            <strong>{{ total_spent|floatformat:2|intcomma }}€</strong>
          </div>
          <div class="kpi-card">
            <h4 class="small muted">Avanzamento Finanziario</h4>
            <strong>{{ progress_percent|floatformat:2 }}%</strong>
            <div class="progress-bar-container">
              {% with progress_percent as pct %}
                {% if pct < 70 %}
                  {% with 'ok' as status_class %}
                {% elif pct < 90 %}
                  {% with 'warn' as status_class %}
                {% else %}
                  {% with 'bad' as status_class %}
                {% endif %}
                <div class="progress-bar {{ status_class }}" style="width:{{ progress_percent }}%"></div>
              {% endwith %}
            </div>
          </div>
          <div class="kpi-card">
            <h4 class="small muted">Milestone Completate</h4>
            <strong>{{ completed_milestones }}/{{ total_milestones }}</strong>
            <div class="progress-bar-container">
                <div class="progress-bar ok" style="width:{{ milestone_progress_percent|floatformat:0 }}%"></div>
            </div>
          </div>
        </div>

        <div style="margin-top:16px;border-top:1px solid var(--br);padding-top:16px">
          <div class="grid cols-2">
            <div>
              <p class="small muted" style="margin:0 0 4px">Titolo Progetto</p>
              <p style="margin:0">{{ project.title }}</p>

              <p class="small muted" style="margin:12px 0 4px">Programma</p>
              <p style="margin:0" class="chip">{{ project.get_program_display }}</p>
            </div>
            <div>
              <p class="small muted" style="margin:0 0 4px">Date</p>
              <p style="margin:0">
                Inizio: **{{ project.start_date|date:"d/m/Y"|default:"N/D" }}**<br>
                Fine: **{{ project.end_date|date:"d/m/Y"|default:"N/D" }}**
              </p>

              <p class="small muted" style="margin:12px 0 4px">Stato</p>
              <p style="margin:0" class="chip">{{ project.get_status_display }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px">
        <h3 style="margin-top:0">Timeline e Milestone</h3>
        {% if project_start and project_end %}
          <div class="timeline-container">
            <div class="timeline-bar"></div>

            {% if today_pos_percent is not None %}
            <div class="today-marker" style="left:{{ today_pos_percent|floatformat:2 }}%" title="Oggi: {{ today }}">
              <div class="today-label">Oggi</div>
            </div>
            {% endif %}

            {% for ms in milestones %}
              {% if ms.pos_percent is not None %}
                {% with ms.status|lower as status %}
                <div class="ms-marker {% if status == 'completed' %}completed{% elif status == 'delayed' %}delayed{% endif %}"
                     style="left:{{ ms.pos_percent|floatformat:2 }}%"
                     title="{{ ms.title }} ({{ ms.get_status_display }}) - Scadenza: {{ ms.due_date|date:'d/m/Y' }}">
                </div>
                {% endwith %}
              {% endif %}
            {% endfor %}
          </div>
          <div class="timeline-details">
            <small>{{ project_start|date:"d/m/Y" }}</small>
            <small>{{ project_end|date:"d/m/Y" }}</small>
          </div>
        {% else %}
          <p class="muted text-center">Definire le date di inizio e fine progetto per visualizzare la timeline.</p>
        {% endif %}

        {% if milestones %}
        <div style="margin-top:24px;border-top:1px solid var(--br);padding-top:16px">
          <table class="simple-table">
            <thead>
              <tr>
                <th>Milestone</th>
                <th>Scadenza</th>
                <th>Stato</th>
              </tr>
            </thead>
            <tbody>
              {% for ms in milestones %}
              <tr>
                <td>{{ ms.title }}</td>
                <td>{{ ms.due_date|date:"d/m/Y" }}</td>
                <td>
                  {% with ms.status|lower as status %}
                    <span class="chip" style="background:
                      {% if status == 'completed' %}var(--ok);color:#fff;
                      {% elif status == 'delayed' %}var(--warn);color:#fff;
                      {% elif status == 'canceled' %}var(--muted);color:#fff;
                      {% else %}#eee;color:var(--ink);
                      {% endif %}">
                      {{ ms.get_status_display }}
                    </span>
                  {% endwith %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}

        <details style="margin-top:16px" {% if add_milestone %}open{% endif %}>
          <summary class="btn">+ Aggiungi milestone</summary>
          <form method="post" action="" style="margin-top:12px" class="grid cols-2">
            {% csrf_token %}
            <input type="hidden" name="op" value="add_milestone" />
            <div style="grid-column:1/-1">
              <label class="small muted">Titolo</label><br>
              <input type="text" name="title" required placeholder="Es. Acquisto materiale didattico">
            </div>
            <div>
              <label class="small muted">Data di Scadenza</label><br>
              <input type="date" name="due_date" required>
            </div>
            <div>
              <label class="small muted">Stato Iniziale</label><br>
              <select name="status">
                <option value="PENDING">In attesa</option>
                <option value="COMPLETED">Completata</option>
              </select>
            </div>
            <div style="grid-column:1/-1">
              <label class="small muted">Descrizione (facoltativa)</label><br>
              <textarea name="description" rows="3"></textarea>
            </div>
            <div>
              <button class="btn primary" type="submit">Aggiungi Milestone</button>
            </div>
          </form>
        </details>
      </div>

      <div class="grid cols-2">

        <div class="col-8">
          <div class="card">
            <h3 style="margin-top:0">Spese Registrate</h3>

            <form method="get" action="" style="display:flex;gap:12px;margin-bottom:12px;padding:12px 0;border-bottom:1px solid var(--br)">
              <div style="flex-grow:1">
                <label class="small muted">Fornitore</label><br>
                <input type="text" name="vendor" value="{{ request.GET.vendor|default:"" }}" onchange="this.form.submit()" placeholder="Cerca...">
              </div>

              <div>
                <label class="small muted">Categoria</label><br>
                <select name="category" onchange="this.form.submit()">
                  <option value="">Tutte</option>
                  {% for val,label in category_choices %}
                    <option
                        value="{{ val }}"
                        {% if current_category|stringformat:"s" == val|stringformat:"s" %}selected{% endif %}>
                        {{ label }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="small muted" style="visibility:hidden">Reset</label><br>
                <a href="{% url 'project_detail' project.pk %}" class="btn">Reset</a>
              </div>
            </form>
            {% if expenses %}
            <p class="small muted">Totale filtrato: <strong>{{ filtered_total|floatformat:2|intcomma }}€</strong></p>
            <table class="simple-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Categoria</th>
                  <th>Fornitore</th>
                  <th class="text-right">Importo</th>
                  <th>Doc. Rif.</th>
                  <th>Note</th>
                  <th class="text-right">Azioni</th>
                </tr>
              </thead>
              <tbody>
                {% for exp in expenses %}
                <tr>
                  <td>{{ exp.date|date:"d/m/Y" }}</td>
                  <td>{{ exp.category.name|default:"N/D" }}</td>
                  <td>{{ exp.vendor|default:"N/D" }}</td>
                  <td class="text-right">{{ exp.amount|floatformat:2|intcomma }}€</td>
                  <td>{{ exp.document|default:"N/D" }}</td>
                  <td>{{ exp.note|default:"N/D" }}</td>
                  <td class="text-right">
                    <a href="{% url 'expense_edit' exp.pk %}">Modifica</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
              <p class="muted text-center">Nessuna spesa registrata per questo progetto (o per i filtri selezionati).</p>
            {% endif %}

            <details style="margin-top:16px" {% if add_expense %}open{% endif %}>
              <summary class="btn">+ Aggiungi spesa</summary>
              <form method="post" action="" style="margin-top:12px" class="grid cols-2">
                {% csrf_token %}
                <input type="hidden" name="op" value="add_expense" />
                <div>
                  <label class="small muted">Data</label><br>
                  <input type="date" name="date" value="{{ 'now'|date:'Y-m-d' }}" required>
                </div>
                <div>
                  <label class="small muted">Importo</label><br>
                  <input type="number" name="amount" step="0.01" min="0.01" required placeholder="Es. 1250.00">
                </div>
                <div>
                  <label class="small muted">Categoria</label><br>
                  <select name="category" required>
                    <option value="">Seleziona...</option>
                    {% for val,label in category_choices %}
                      <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="small muted">Fornitore</label><br>
                  <input type="text" name="vendor" placeholder="Es. Amazon o N/D">
                </div>
                <div>
                  <label class="small muted">Rif. Documento/Fattura</label><br>
                  <input type="text" name="document" placeholder="Es. FT2025/123 o CIG/CUP">
                </div>
                <div>
                  <label class="small muted">Nota</label><br>
                  <input type="text" name="note" placeholder="Breve nota (facoltativa)">
                </div>
                <div style="grid-column:1/-1">
                  <button class="btn primary" type="submit">Registra Spesa</button>
                </div>
              </form>
            </details>
          </div>
        </div>

        <div class="col-4">
          <div class="card">
            <h3 style="margin-top:0">Budget e Controlli</h3>

            {% if project.budget > total_spent %}
            <p class="kpi-card" style="background:#e6ffec;border-color:var(--ok)">
              <h4 class="small muted" style="color:var(--ok)">Fondi Rimanenti</h4>
              <strong style="color:var(--ok)">
                {{ project.budget|sub:total_spent|floatformat:2|intcomma }}€
              </strong>
            </p>
            {% else %}
            <p class="kpi-card" style="background:#fee2e2;border-color:var(--bad)">
              <h4 class="small muted" style="color:var(--bad)">Budget Superato</h4>
              <strong style="color:var(--bad)">
                {{ total_spent|sub:project.budget|floatformat:2|intcomma }}€
              </strong>
            </p>
            {% endif %}

            {% if limits_ctx %}
            <div class="card" style="margin-top:16px">
              <h3 style="margin-top:0">Limiti di Spesa</h3>
              <table class="simple-table" style="font-size:0.85rem">
                <thead>
                  <tr>
                    <th>Categoria</th>
                    <th>Base</th>
                    <th>% Max</th>
                    <th class="text-right">Speso</th>
                  </tr>
                </thead>
                <tbody>
                  {% for lim in limits_ctx %}
                  <tr>
                    <td class="chip">{{ lim.category_label }}</td>
                    <td>{{ lim.base_label }}</td>
                    <td>{{ lim.percentage }}%</td>
                    <td class="text-right">
                      {{ lim.spent_in_category|floatformat:2|intcomma }}€
                      {% with lim.pct_used as pct %}
                      {% if pct > 100 %}<span style="color:var(--bad)"> ({{ pct|floatformat:0 }}%)</span>
                      {% else %}<span style="color:var(--muted)"> ({{ pct|floatformat:0 }}%)</span>
                      {% endif %}
                      {% endwith %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% endif %}

            <details style="margin-top:16px" {% if add_limit %}open{% endif %}>
              <summary class="btn">+ Aggiungi limite</summary>
              <form method="post" action="" style="margin-top:12px" class="grid">
                {% csrf_token %}
                <input type="hidden" name="op" value="add_limit" />
                <div>
                  <label class="small muted">Categoria</label><br>
                  <select name="category" required>
                    <option value="">Seleziona...</option>
                    {% for val,label in category_choices %}
                      <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="small muted">Base</label><br>
                  <select name="base" required>
                    {% for val,label in base_choices %}
                      <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label class="small muted">% Limite</label><br>
                  <input type="number" name="percentage" step="0.01" min="0" required placeholder="Es. 20.00">
                </div>
                <div style="grid-column:1/-1">
                  <label class="small muted">Nota</label><br>
                  <input type="text" name="note" placeholder="Facoltativa">
                </div>
                <div>
                  <button class="btn primary" type="submit">Imposta Limite</button>
                </div>
              </form>
            </details>
          </div>
        </div>

      </div>
    </div>
  </main>
</body>
</html>