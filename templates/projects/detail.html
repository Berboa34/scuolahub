<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ project.title }} – Dettaglio progetto</title>
  <style>
    :root{--bg:#f7f7fb;--panel:#ffffff;--ink:#1b1f24;--muted:#6b7280;--primary:#2563eb;--line:#e5e7eb;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .input{border:1px solid var(--line);padding:10px 12px;border-radius:10px;background:#fff}
    .btn{border:1px solid var(--line);padding:10px 14px;border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    .muted{color:var(--muted)}
    .status{font-size:.8rem;font-weight:600;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .status.active{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .status.closed{background:#fef2f2;color:#7f1d1d;border-color:#fecaca}
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:1000px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">{{ project.title }}
            <span class="status {% if project.status == 'ACTIVE' %}active{% elif project.status == 'CLOSED' %}closed{% endif %}">
              {{ project.get_status_display }}
            </span>
          </h2>
          <div class="muted">
            {{ project.get_program_display }}{% if project.cup %} · CUP {{ project.cup }}{% endif %}{% if project.cig %} · CIG {{ project.cig }}{% endif %}
            {% if project.start_date %} · {{ project.start_date }} – {{ project.end_date|default:"—" }}{% endif %}
          </div>
        </div>
        <div>
          <a class="btn" href="{% url 'projects_list' %}">← Torna ai progetti</a>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div>
        <div class="card">
          <h3 style="margin-top:0">Spese</h3>

          <form method="get" class="toolbar" style="margin-bottom:10px">
            <select name="cat" class="input">
              <option value="">Categoria: tutte</option>
              <option value="MATERIALI" {% if cat == 'MATERIALI' %}selected{% endif %}>Materiali</option>
              <option value="SERVIZI" {% if cat == 'SERVIZI' %}selected{% endif %}>Servizi</option>
              <option value="FORMAZIONE" {% if cat == 'FORMAZIONE' %}selected{% endif %}>Formazione</option>
              <option value="ALTRO" {% if cat == 'ALTRO' %}selected{% endif %}>Altro</option>
            </select>
            <input name="vendor" value="{{ vendor }}" class="input" placeholder="Fornitore…">
            <button class="btn">Filtra</button>
            <a class="btn" href="{% url 'project_detail' project.id %}">Pulisci</a>
          </form>

          <table>
            <thead>
              <tr><th>Data</th><th>Fornitore</th><th>Categoria</th><th>Importo</th><th>Doc</th></tr>
            </thead>
            <tbody>
              {% for e in expenses %}
                <tr>
                  <td>{{ e.date }}</td>
                  <td>{{ e.vendor|default:"—" }}</td>
                  <td>{{ e.get_category_display|default:"—" }}</td>
                  <td>€ {{ e.amount }}</td>
                  <td>{{ e.document_no|default:"—" }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="5">Nessuna spesa trovata.</td></tr>
              {% endfor %}
            </tbody>
          </table>

          <p class="muted" style="margin-top:6px">Totale (filtrato): € {{ total_expenses }}</p>

          <h4 style="margin-top:18px">Aggiungi spesa</h4>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_expense">
            {{ form.as_p }}
            <button class="btn primary" type="submit">Salva spesa</button>
          </form>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 style="margin-top:0">Pannello progetto</h3>
          <div class="muted">Budget: <b>€ {{ project.budget }}</b> · Speso: <b>€ {{ project.spent }}</b></div>
          <div class="muted">Avanzamento spesa: <b>{{ percent }}%</b></div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Limiti di spesa</h3>
          <table>
            <thead>
              <tr><th>Regola</th><th>Tetto (€)</th><th>Speso (€)</th><th>Residuo (€)</th><th>Stato</th></tr>
            </thead>
            <tbody>
              {% for row in limits %}
                <tr>
                  <td>{{ row.obj.get_category_display }} ≤ {{ row.obj.percent }}% del {{ row.base_label }}</td>
                  <td>€ {{ row.cap }}</td>
                  <td>€ {{ row.spent }}</td>
                  <td>€ {{ row.remaining }}</td>
                  <td>
                    {% if row.over %}
                      <span class="status closed">Sforato</span>
                    {% else %}
                      <span class="status active">OK</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5">Nessun limite impostato.</td></tr>
              {% endfor %}
            </tbody>
          </table>

          <h4 style="margin-top:18px">Nuovo limite</h4>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_limit">
            {{ limit_form.as_p }}
            <button class="btn" type="submit">Aggiungi limite</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</body>
</html>
