{% load humanize %}
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Calendario — ScuolaHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b2a42; --light:#f5f7fb; --muted:#6b7280; --br:#e5e7eb;
      --accent:#0b5cab; --today:#fee2e2;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:#f3f4f6}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    header{background:var(--bg);color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{font-weight:600;font-size:20px}
    nav a{margin-right:12px;color:#cde1ff}
    nav a.active{font-weight:700;color:#fff}
    main{padding:16px}
    .card{background:#fff;border-radius:10px;border:1px solid var(--br);padding:16px;margin-bottom:16px}
    .muted{color:var(--muted)}
    .calendar-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px}
    .calendar-header h1{margin:0;font-size:20px}
    .btn{display:inline-block;padding:6px 10px;border-radius:8px;border:1px solid var(--br);background:#fff;cursor:pointer;font-size:13px}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .grid-month{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));border:1px solid var(--br);border-radius:10px;overflow:hidden;font-size:13px}
    .dow{background:#eef2ff;padding:8px;text-align:center;font-weight:600;border-bottom:1px solid var(--br)}
    .day{min-height:90px;border-right:1px solid var(--br);border-bottom:1px solid var(--br);padding:4px 6px;background:#fff;vertical-align:top}
    .day.out{background:#f9fafb;color:#9ca3af}
    .day-today{background:var(--today)}
    .day-number{font-size:12px;font-weight:600;margin-bottom:4px}
    .events{display:flex;flex-direction:column;gap:3px}
    .event-pill{border-radius:6px;padding:2px 4px;background:#e0f2fe;border:1px solid #bae6fd;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small{font-size:13px}
    form.inline{display:inline}
    .form-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .form-grid-wide{grid-column:1/-1}
    input[type="text"], input[type="date"], select, textarea{
      width:100%;padding:6px 8px;border-radius:8px;border:1px solid var(--br);font-size:13px
    }
    textarea{min-height:60px;resize:vertical}
    @media (max-width: 800px){
      .form-grid{grid-template-columns:1fr}
      .grid-month{font-size:11px}
    }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">ScuolaHub</div>
      <nav class="small">
        <a href="{% url 'dashboard' %}">Dashboard</a>
        <a href="{% url 'projects_list' %}">Progetti</a>
        <a href="{% url 'calendar_view' %}" class="active">Calendario</a>
        <a href="{% url 'documents' %}">Documenti</a>
        <a href="{% url 'deleghe' %}">Deleghe</a>
        <a href="{% url 'settings' %}">Impostazioni</a>
      </nav>
    </div>
    <div class="small muted">
      Utente: <b>{{ request.user.username }}</b>
      {% if school %}· Scuola: <b>{{ school.name }}</b>{% endif %}
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="calendar-header">
      <div>
        <h1>{{ month_label }}</h1>
        <div class="small muted">
          Calendario personale — mostra gli eventi collegati al tuo utente.
        </div>
      </div>
      <div>
        <a class="btn" href="{% url 'calendar_view' %}?year={{ prev_year }}&month={{ prev_month }}">« Mese precedente</a>
        <a class="btn" href="{% url 'calendar_view' %}?year={{ next_year }}&month={{ next_month }}">Mese successivo »</a>
      </div>
    </div>

    <!-- Griglia calendario -->
    <div class="grid-month">
      <!-- Intestazione giorni della settimana -->
      <div class="dow">Lun</div>
      <div class="dow">Mar</div>
      <div class="dow">Mer</div>
      <div class="dow">Gio</div>
      <div class="dow">Ven</div>
      <div class="dow">Sab</div>
      <div class="dow">Dom</div>

      <!-- Celle -->
      {% for week in weeks %}
        {% for cell in week %}
          <div class="day {% if not cell.in_month %}out{% endif %}{% if cell.is_today %} day-today{% endif %}">
            <div class="day-number">{{ cell.date.day }}</div>
            <div class="events">
              {% for ev in cell.events %}
                <div class="event-pill" title="{{ ev.title }}{% if ev.project %} — Progetto: {{ ev.project.title }}{% endif %}">
                  {{ ev.title }}{% if ev.project %} ({{ ev.project.title }}){% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
  </section>

  <!-- Sezione aggiungi evento -->
  <section class="card">
    <h2 style="margin-top:0;font-size:18px">Aggiungi un evento</h2>
    <p class="small muted">
      L'evento verrà collegato al tuo utente e, se selezioni un progetto, anche al progetto scelto.
    </p>

    <form method="post" action="">
      {% csrf_token %}
      <div class="form-grid">
        <div>
          <label class="small muted">Titolo</label>
          <input type="text" name="title" placeholder="Es. Riunione team PNRR" required>
        </div>
        <div>
          <label class="small muted">Data</label>
          <input type="date" name="date" value="{{ today }}" required>
        </div>
        <div>
          <label class="small muted">Progetto (facoltativo)</label>
          <select name="project_id">
            <option value="">— Nessun progetto —</option>
            {% for p in projects %}
              <option value="{{ p.id }}">{{ p.title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-grid-wide">
          <label class="small muted">Descrizione (facoltativa)</label>
          <textarea name="description" placeholder="Dettagli dell'evento, partecipanti, note operative…"></textarea>
        </div>
        <div>
          <button type="submit" class="btn primary">Salva evento</button>
        </div>
      </div>
    </form>
  </section>
</main>

</body>
</html>
